<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>è²·å–è¡¨ | ãƒˆãƒ¬ã‚«ãƒ•ã‚©ãƒ¼ã‚¹</title>
  <link rel="icon" href="data:,">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
    :root {
      --accent: #58BDD7; 
      --accent-hover: #4aaec7;
      --price-color: #ffffff;
      --bg-dark: #121212;
      --card-bg: #1e1e1e;
      --text-main: #ffffff;
      --border: #555555;
      --glow-text: 0 0 8px rgba(88, 189, 215, 0.6);
      --glow-price: 0 0 10px rgba(255, 255, 255, 0.7); 
      --glow-box: 0 0 12px rgba(88, 189, 215, 0.4);
    }
    body.mail-mode {
      --accent: #b472ff; 
      --accent-hover: #9e5be0;
      --glow-text: 0 0 8px rgba(180, 114, 255, 0.6);
      --glow-price: 0 0 10px rgba(255, 255, 255, 0.7); 
      --glow-box: 0 0 12px rgba(180, 114, 255, 0.4);
    }
    body { 
      font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; 
      color: var(--text-main); background-color: var(--bg-dark);
      background-image: url('./bg-gray.jpg.png'); background-size: cover;
      background-position: center; background-attachment: fixed;
      display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; 
      transition: all 0.5s ease;
    }
    body::before {
      content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: -1;
    }
    * { box-sizing: border-box; }

    /* Pull to Refresh */
    #ptr-indicator {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      background: rgba(30, 30, 30, 0.95); border: 2px solid var(--accent); color: var(--accent);
      padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 12px;
      z-index: 11000; opacity: 0; transition: top 0.2s ease, opacity 0.2s ease;
      pointer-events: none; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 0 15px var(--accent);
    }
    #ptr-indicator.visible { opacity: 1; top: 90px; }
    .spinner {
      width: 16px; height: 16px; border: 3px solid transparent; 
      border-top-color: var(--accent); border-right-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Header */
    header { 
      background: #111; border-bottom: 2px solid var(--accent); 
      padding: 5px 15px; position: relative; z-index: 100;
      display: flex; justify-content: space-between; align-items: center; 
      height: 70px; transition: border-bottom 0.5s ease;
    }
    .header-left, .header-right { display: flex; align-items: center; gap: 15px; z-index: 102; position: relative; }
    .hamburger { width: 24px; height: 18px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
    .hamburger span { display: block; height: 2px; width: 100%; background: var(--text-main); border-radius: 2px; transition: 0.3s; }
    .header-center {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 100%; text-align: center; z-index: 101; pointer-events: none;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .title-text {
      font-size: 22px; font-weight: 900; color: var(--accent); text-shadow: var(--glow-text);
      font-style: italic; letter-spacing: 1px; white-space: nowrap; line-height: 1.1;
      margin-bottom: 4px; transition: color 0.5s;
    }
    #date-display {
      display: block; font-size: 10px; color: #fff; font-weight: bold; padding: 2px 10px;
      border-radius: 12px; border: 1px solid var(--accent); box-shadow: var(--glow-box);
      background: rgba(0, 0, 0, 0.6); white-space: nowrap; transition: all 0.5s ease;
    }
    .logo-img { height: 40px; width: auto; object-fit: contain; filter: none; }
    .header-cart-btn { display: none; position: relative; font-size: 20px; color: #fff; cursor: pointer; }
    body.mail-mode .header-cart-btn { display: block; }
    .cart-badge {
      position: absolute; top: -8px; right: -10px; background: #ff5252; color: #fff;
      font-size: 10px; font-weight: bold; width: 18px; height: 18px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; border: 1px solid #fff;
    }

    /* Drawer */
    .drawer {
      position: fixed; top: 0; left: -280px; width: 260px; height: 100%;
      background: #1a1a1a; z-index: 99999; transition: left 0.3s ease;
      box-shadow: 2px 0 15px rgba(0,0,0,0.8); display: flex; flex-direction: column;
    }
    .drawer.open { left: 0; }
    .drawer-header {
      padding: 20px; font-size: 18px; font-weight: bold; color: var(--accent);
      border-bottom: 1px solid #333; background: #111; text-shadow: var(--glow-text);
    }
    .drawer-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
    .drawer-item {
      padding: 15px 20px; border-bottom: 1px solid #2a2a2a; 
      cursor: pointer; color: #eee; font-weight: bold; font-size:15px;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3); transition: all 0.3s;
    }
    .drawer-item:hover { background: #2a2a2a; color: var(--accent); text-shadow: var(--glow-text); }
    .drawer-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); z-index: 99998;
      display: none; opacity: 0; transition: opacity 0.3s ease;
    }
    .drawer-overlay.open { display: block; opacity: 1; }

    /* Main UI Elements */
    .slider-container { width: 100%; max-width: 1000px; margin: 0 auto; position: relative; overflow: hidden; display: none; background: #000; border-bottom: 1px solid #333; }
    body.mail-mode .slider-container { display: block; }
    .slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
    .slider-slide { min-width: 100%; }
    .slider-slide img { width: 100%; height: auto; display: block; max-height: 250px; object-fit: cover; }
    .slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
    .slider-dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; cursor: pointer; }
    .slider-dot.active { background: #fff; transform: scale(1.2); box-shadow: 0 0 5px #fff; }

    .mail-deadline-box {
      display: none; max-width: 1000px; margin: 15px auto 5px; padding: 12px;
      border: 2px solid #FFD700; background: rgba(212, 175, 55, 0.15); 
      color: #ffffff; font-size: 12px; font-weight: bold; line-height: 1.6;
      border-radius: 6px; text-align: left;
    }
    body.mail-mode .mail-deadline-box { display: block; }
    .deadline-highlight { color: #FFD700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); font-size:13px;}
    @media (max-width: 600px) { .br-sp { display: block; } .mail-deadline-box { font-size: 11px; line-height: 1.5; padding: 10px 12px; } }
    @media (min-width: 601px) { .br-sp { display: none; } }

    .sticky-container {
      position: sticky; top: 0; z-index: 9990;
      background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(5px);
      border-bottom: 1px solid #444; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .nav-scroll { overflow-x: auto; white-space: nowrap; padding: 0 10px; border-bottom: 1px solid #333; }
    .nav-tabs { display: flex; gap: 10px; max-width: 1000px; margin: 0 auto; padding: 0; list-style: none; align-items: center; }
    .nav-item { cursor: pointer; padding: 14px 12px; font-weight: bold; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; font-size: 14px; }
    .nav-item:hover { color: #fff; text-shadow: 0 0 5px #fff; }
    .nav-item.active { color: var(--accent); border-bottom-color: var(--accent); text-shadow: var(--glow-text); }

    .filters { max-width: 1000px; margin: 0 auto; padding: 10px 12px; display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .search-box { grid-column: 1 / 2; grid-row: 1; position: relative; width: 100%; }
    body:not(.mail-mode) .search-box { grid-column: 1 / 3; }
    .search-box input { width: 100%; padding: 8px 8px 8px 30px; border: 1px solid #555; border-radius: 4px; outline: none; font-size: 13px; background: rgba(30, 30, 30, 0.8); color: #fff; transition: border-color 0.3s, box-shadow 0.3s; }
    .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 5px var(--accent); }
    .search-icon { position: absolute; left: 8px; top: 9px; color: #aaa; font-size: 12px; }

    .header-action-btn {
      grid-column: 2 / 3; grid-row: 1; background: transparent; border: 1px solid var(--accent); color: var(--accent);
      display: flex; align-items: center; gap: 5px; padding: 8px 8px; font-size: 11px; justify-self: end; border-radius: 4px; cursor: pointer;
      width: 100px; justify-content: center; white-space: nowrap;
    }
    .header-action-btn:hover { background: rgba(88, 189, 215, 0.1); }
    body.mail-mode .header-action-btn:hover { background: rgba(180, 114, 255, 0.1); }
    .flow-btn, .rules-btn { display: none; }
    body.mail-mode .flow-btn { display: flex; }
    body:not(.mail-mode) .rules-btn { display: flex; }
    .filter-row-2 { grid-column: 1 / 3; grid-row: 2; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    #sort { padding: 8px; border: 1px solid #555; border-radius: 4px; background: rgba(30, 30, 30, 0.8); color: #fff; cursor: pointer; font-size: 12px; width: auto; min-width: 100px; max-width: 160px; flex: 0 1 auto; }
    #showSoldOutLabel { display: flex; align-items: center; font-size: 12px; color: #fff; cursor: pointer; gap: 6px; white-space: nowrap; }
    #reload { display: none; }

    /* Card List */
    .container { max-width: 1000px; margin: 20px auto 0; padding: 0 12px 20px; flex: 1; width: 100%; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .card { background: var(--card-bg); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.6); display: flex; flex-direction: column; position: relative; transition: all 0.2s ease; }
    body:not(.mail-mode) .card:hover { transform: translateY(-4px); border-color: var(--accent); box-shadow: var(--glow-box); }
    .card.sold-out { border-color: #333; box-shadow: none; }
    .card.sold-out:hover { transform: none; border-color: #333; }
    .card-img { width: 100%; aspect-ratio: 3/4; background: #000; object-fit: contain; border-bottom: 1px solid #333; }
    .no-img { display: flex; align-items: center; justify-content: center; color: #555; font-size: 10px; background: #222; }
    .card-body { padding: 8px; flex: 1; display: flex; flex-direction: column; position: relative; }
    .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .type-label { 
      display: inline-block; font-size: 9px; color: #fff; font-weight: 900; 
      background: var(--accent); border: 1px solid var(--accent); 
      padding: 1px 5px; border-radius: 3px; line-height: 1.2; box-shadow: var(--glow-box);
    }
    .limit-badge { font-size: 10px; color: #fff; background: #444; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .card-title { font-size: 12px; font-weight: bold; line-height: 1.4; margin-bottom: 6px; color: #fff; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 34px; }
    .card-tags { position: absolute; top: 4px; right: 4px; display: flex; flex-direction: column; gap: 2px; align-items: flex-end; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #333; color: #fff; border: 1px solid #555; }
    .badge-sotai { background: #555; color: #eee; }
    .card-footer { margin-top: auto; border-top: 1px solid #444; padding-top: 6px; }
    .price-row { display: flex; align-items: baseline; justify-content: space-between; gap: 4px; }
    .price-label { font-size: 9px; color: #aaa; }
    .price-value { color: var(--price-color); font-size: 16px; font-weight: 800; text-shadow: var(--glow-price); }

    /* Cart */
    .cart-actions { display: none; margin-top: 8px; gap: 4px; align-items: center; }
    body.mail-mode .cart-actions { display: flex; }
    .qty-group { display: flex; align-items: center; border: 1px solid #555; border-radius: 4px; background: #fff; height: 28px; overflow: hidden; }
    .qty-btn { width: 24px; height: 100%; background: #eee; border: none; color: #333; font-weight: bold; padding: 0; display:flex; align-items:center; justify-content:center; }
    .qty-input { width: 24px; height: 100%; border: none; text-align: center; font-size: 12px; color: #333; font-weight: bold; padding: 0; background: #fff; }
    .add-btn { flex: 1; height: 28px; font-size: 11px; background: var(--accent); color: #fff; border-radius: 4px; border:none; cursor: pointer; }
    .sold-out-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:50; display:flex; align-items:center; justify-content:center; }
    .sold-out-badge { background: var(--accent); color: #fff; font-weight: 900; font-size: 12px; padding: 6px 12px; border-radius: 4px; border: 2px solid #fff; box-shadow: var(--glow-box); }
    body.mail-mode .sold-out-badge { background: #b472ff; }

    .cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; border-top: 2px solid var(--accent); padding: 15px; z-index: 20000; display: flex; justify-content: space-between; align-items: center; transform: translateY(100%); transition: transform 0.3s ease; box-shadow: 0 -4px 20px rgba(0,0,0,0.5); }
    .cart-bar.visible { transform: translateY(0); }
    .cart-total-info { font-size: 14px; font-weight: bold; color: #fff; }
    .cart-total-price { font-size: 20px; color: var(--accent); margin-right: 10px; font-weight: bold; text-shadow: var(--glow-text); }
    .check-cart-btn { padding: 10px 20px; background: var(--accent); color: #fff; font-weight: bold; border-radius: 4px; border:none; cursor: pointer; }
    #cartView { display: none; padding: 20px; max-width: 800px; margin: 0 auto; color: #fff; }
    .cart-header { font-size: 20px; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
    .cart-item { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #333; align-items: flex-start; }
    .cart-item-img { width: 60px; height: 80px; background: #000; object-fit: contain; border: 1px solid #444; }
    .cart-item-info { flex: 1; }
    .cart-item-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
    .cart-item-meta { font-size: 12px; color: #aaa; margin-bottom: 5px; }
    .cart-item-price { font-size: 16px; color: var(--accent); font-weight: bold; }
    .cart-item-actions { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .delete-btn { background: #ff5252; color: #fff; padding: 5px 10px; font-size: 11px; border-radius: 4px; border: none; cursor: pointer; }

    /* Info View & Member Card */
    #infoView { display: none; padding: 20px; max-width: 800px; margin: 0 auto; color: #ddd; line-height: 1.8; font-size: 14px; text-align: left; }
    .company-links { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 40px; }
    .company-btn {
      padding: 15px 0; background: #1a1a1a; border: 2px solid var(--accent); 
      color: var(--accent); font-weight: 900; font-size: 16px; border-radius: 8px; cursor: pointer;
      text-decoration: none; display: flex; justify-content: center; align-items: center; transition: all 0.3s;
    }
    .company-btn:hover { background: var(--accent); color: #fff; box-shadow: var(--glow-text); }
    .back-btn-container { text-align: left; margin-bottom: 20px; }
    .back-btn-container button { padding: 8px 16px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .flow-step { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent); }
    .flow-title { font-size: 16px; font-weight: bold; color: var(--accent); margin-bottom: 10px; text-shadow: var(--glow-text); }
    .note-box { background: rgba(255, 50, 50, 0.1); border: 1px solid #ff5252; padding: 15px; border-radius: 8px; margin-top: 30px; }
    .note-title { color: #ff5252; font-weight: bold; margin-bottom: 10px; font-size: 16px; }

    /* ä¼šå“¡è¨¼ãƒ»ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .member-card { background: #fff; color: #000; border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
    .member-card-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px; display:inline-block;}
    .member-barcode { margin: 20px 0; }
    .member-info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom:1px solid #eee; padding-bottom:4px;}
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--accent); }
    .form-input { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; }
    .form-submit { width: 100%; padding: 15px; background: var(--accent); color: #fff; font-weight: bold; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .upload-btn { border: 2px dashed #555; color: #aaa; background: #222; padding: 20px; border-radius: 8px; width: 100%; text-align: center; cursor: pointer; }
    .upload-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; justify-content: center; align-items: center; padding: 15px; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal-content { background: #1e1e1e; border: 2px solid var(--accent); border-radius: 12px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; position: relative; padding: 20px; box-shadow: 0 0 30px rgba(88, 189, 215, 0.2); }
    body.mail-mode .modal-content { box-shadow: 0 0 30px rgba(180, 114, 255, 0.2); }
    .close-modal { position: absolute; top: 10px; right: 15px; font-size: 32px; color: #888; cursor: pointer; }
    .modal-img-wrapper { text-align: center; margin-bottom: 15px; background:#000; padding:10px; border-radius:8px;}
    .modal-img { max-height: 300px; max-width: 100%; object-fit: contain; }
    .modal-title { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 15px; }
    .modal-row { display: flex; justify-content: space-between; align-items: baseline; margin-top:10px;}
    .modal-price { font-size: 32px; color: #ffffff; font-weight: 900; text-shadow: var(--glow-price); }
    .modal-label { font-size: 12px; color: #aaa; }
    .modal-cart-actions { margin-top: 15px; border-top: 1px solid #444; padding-top: 15px; display: none; align-items: center; gap: 10px; }
    body.mail-mode .modal-cart-actions { display: flex; }
    .modal-qty-group { display: flex; align-items: center; border: 1px solid #555; border-radius: 4px; background: #fff; height: 36px; overflow: hidden; }
    .modal-qty-btn { width: 30px; height: 100%; background: #eee; border: none; color: #333; font-weight: bold; font-size: 16px; cursor: pointer; }
    .modal-qty-input { width: 30px; height: 100%; border: none; text-align: center; font-size: 14px; color: #333; font-weight: bold; background: #fff; }
    .modal-add-btn { flex: 1; height: 36px; background: var(--accent); color: #fff; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; }
    
    .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #333; }
    .page-btn { padding: 8px 16px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; cursor: pointer; }
    
    footer { background: #0f0f0f; border-top: 1px solid #333; padding: 20px; text-align: center; margin-top: auto; position: relative; }
    .footer-links { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
    .footer-link { color: #888; font-size: 12px; text-decoration: none; cursor: pointer; }
    .footer-version { position: absolute; bottom: 5px; left: 10px; font-size: 9px; color: #444; }

    @media (max-width: 600px) {
      .grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .card-title { font-size: 10px; height: 28px; }
      .price-value { font-size: 14px; }
      .cart-actions { flex-direction: column; align-items: stretch; }
      .qty-group { margin-bottom: 4px; }
      .filters { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
      .search-box { grid-column: 1 / 2; grid-row: 1; width: 100%; }
      .header-action-btn { grid-column: 2 / 3; grid-row: 1; width: 100px; justify-self: end; padding: 8px 4px; }
      body:not(.mail-mode) .search-box { grid-column: 1 / 2; }
      .filter-row-2 { grid-column: 1 / 3; grid-row: 2; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
      #sort { width: auto; min-width: 100px; flex: 1; max-width: 150px; }
      #showSoldOutLabel { white-space: nowrap; margin-left: 0; }
      #reload { display: none; }
      .br-sp { display: inline; }
      .mail-deadline-box { font-size: 11px; line-height: 1.5; padding: 10px 12px; }
    }
  </style>
</head>
<body>

  <div id="ptr-indicator"><div class="spinner"></div><span>æ›´æ–°ä¸­...</span></div>

  <header>
    <div class="header-left">
      <div class="hamburger" id="hamburgerBtn"><span></span><span></span><span></span></div>
    </div>
    <div class="header-center">
      <div class="title-text" id="mainTitle">åº—é ­è²·å–è¡¨</div>
      <div id="date-display"></div>
    </div>
    <div class="header-right">
      <div class="header-cart-btn" onclick="openCart()">
        <i class="fa-solid fa-cart-shopping"></i>
        <span class="cart-badge" id="headerCartCount">0</span>
      </div>
      <img src="./logo.png.png.png.png" alt="ãƒ­ã‚´" class="logo-img" />
    </div>
  </header>

  <div id="drawerOverlay" class="drawer-overlay"></div>
  <div id="drawerMenu" class="drawer">
    <div class="drawer-header">MENU</div>
    <ul class="drawer-list">
      <li class="drawer-item" id="menuStore">åº—é ­è²·å–è¡¨</li>
      <li class="drawer-item" id="menuMail">éƒµé€è²·å–è¡¨</li>
      <li class="drawer-item" onclick="openInfo('member')">ä¼šå“¡è¨¼ãƒ»ç™»éŒ²</li>
      <li class="drawer-item" onclick="openInfo('company')">ä¼šç¤¾æ¦‚è¦</li>
      <li class="drawer-item" onclick="openInfo('privacy')">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</li>
      <li class="drawer-item" onclick="openInfo('terms')">åˆ©ç”¨è¦ç´„</li>
    </ul>
  </div>

  <div id="mainView">
    <div class="slider-container" id="bannerSlider">
      <div class="slider-wrapper" id="sliderWrapper"></div>
      <div class="slider-dots" id="sliderDots"></div>
    </div>

    <div id="mailDeadline" class="mail-deadline-box"></div>

    <div class="sticky-container">
      <div class="nav-scroll">
        <ul class="nav-tabs" id="categoryTabs">
          <li class="nav-item active" data-cat="ãƒã‚±ãƒ¢ãƒ³">ãƒã‚±ãƒ¢ãƒ³</li>
          <li class="nav-item" data-cat="ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹">ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹</li>
          <li class="nav-item" data-cat="ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«">ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«</li>
          <li class="nav-item" data-cat="éŠæˆ¯ç‹">éŠæˆ¯ç‹</li>
          <li class="nav-item" data-cat="ãƒ´ã‚¡ã‚¤ã‚¹">ãƒ´ã‚¡ã‚¤ã‚¹</li>
          <li class="nav-item" data-cat="ãã®ä»–">ãã®ä»–</li>
        </ul>
      </div>
      <div class="filters">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input id="q" placeholder="æ¤œç´¢" /></div>
        
        <button id="flowBtn" class="header-action-btn flow-btn" onclick="openInfo('flow')"><i class="fa-solid fa-book-open"></i> è²·å–ã®æµã‚Œ</button>
        <button id="rulesBtn" class="header-action-btn rules-btn" onclick="openInfo('rules')"><i class="fa-solid fa-clipboard-check"></i> è²·å–åŸºæº–</button>
        
        <div class="filter-row-2">
          <select id="sort">
            <option value="price_desc">é«˜ã„é †</option>
            <option value="price_asc">å®‰ã„é †</option>
            <option value="type_psa10">PSA10</option>
            <option value="type_mikaifu">æœªé–‹å°</option> 
            <option value="type_sotai">ã‚·ãƒ³ã‚°ãƒ«</option>
            <option value="type_box">BOX</option>
          </select>
          <label id="showSoldOutLabel">
            <input type="checkbox" id="showSoldOut" checked> è²·å–çµ‚äº†
          </label>
        </div>
        
        <button id="reload">æ›´æ–°</button>
      </div>
    </div>

    <div class="container">
      <div id="err" class="error"></div>
      <div id="grid" class="grid"></div>
      <div id="paginationCtrl" class="pagination" style="display:none;">
        <button id="prevBtn" class="page-btn">å‰ã¸</button><span id="pageInfo" class="page-info">1/1</span><button id="nextBtn" class="page-btn">æ¬¡ã¸</button>
      </div>
    </div>
  </div>

  <div id="cartView">
    <div class="back-btn-container" style="text-align:left;">
      <button onclick="closeCart()" style="padding:5px 15px;">ï¼œ æˆ»ã‚‹</button>
    </div>
    <div class="cart-header">ã‚«ãƒ¼ãƒˆã‚’ç·¨é›†</div>
    <div id="cartItemsList"></div>
    <div style="text-align:right; margin-top:20px; font-size:18px; font-weight:bold;">
      åˆè¨ˆ <span style="color:var(--accent); font-size:24px;" id="cartViewTotal">Â¥0</span>
    </div>
  </div>

  <div id="cartBar" class="cart-bar">
    <div class="cart-total-info">
      åˆè¨ˆ <span class="cart-total-price" id="cartTotalPrice">Â¥0</span>
      <span id="cartTotalCount">(0ç‚¹)</span>
    </div>
    <button class="check-cart-btn" onclick="openCart()">ã‚«ãƒ¼ãƒˆã‚’ç¢ºèª</button>
  </div>

  <div id="infoView">
    <div class="back-btn-container" id="infoBackBtnTop" style="display:none;">
      <button onclick="closeInfo()">ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>
    
    <div id="memberSection" style="display:none;">
       <div id="memberCardView" style="display:none;">
          <div class="member-card">
             <div class="member-card-title">TRECA FORCE MEMBER</div>
             <canvas id="barcode"></canvas>
             <div class="member-info-row"><span>ä¼šå“¡ç•ªå·</span><span id="memNo">æœªç™ºè¡Œ</span></div>
             <div class="member-info-row"><span>ãŠåå‰</span><span id="memName">ã‚²ã‚¹ãƒˆ</span></div>
             <div class="member-info-row"><span>ãƒã‚¤ãƒ³ãƒˆ</span><span id="memPoint" style="color:#ff5252;font-weight:bold;">0 pt</span></div>
          </div>
          <button class="company-btn" onclick="showMemberEdit()">ç™»éŒ²æƒ…å ±ã‚’ä¿®æ­£</button>
       </div>

       <div id="memberRegView">
          <h3>ä¼šå“¡ç™»éŒ² / æƒ…å ±ç·¨é›†</h3>
          <div class="form-group">
            <label class="form-label">ãŠåå‰</label>
            <input class="form-input" id="regName" placeholder="å±±ç”° å¤ªéƒ">
          </div>
          <div class="form-group">
            <label class="form-label">é›»è©±ç•ªå·</label>
            <input class="form-input" id="regTel" placeholder="090-1234-5678">
          </div>
          <div class="form-group">
            <label class="form-label">ä½æ‰€</label>
            <input class="form-input" id="regAddress" placeholder="ã€’000-0000 æ±äº¬éƒ½...">
          </div>
          <div class="form-group">
            <label class="form-label">æŒ¯è¾¼å…ˆå£åº§</label>
            <input class="form-input" id="regBank" placeholder="ã€‡ã€‡éŠ€è¡Œ ã€‡ã€‡æ”¯åº— æ™®é€š 1234567">
          </div>
          <div class="form-group">
             <label class="form-label">èº«åˆ†è¨¼ç”»åƒï¼ˆå…è¨±è¨¼ãªã©ï¼‰</label>
             <div class="upload-btn-wrapper">
               <div class="upload-btn">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
               <input type="file" id="regLicense" style="position:absolute;top:0;left:0;opacity:0;width:100%;height:100%;">
             </div>
          </div>
          <button class="form-submit" onclick="submitMember()">ç™»éŒ²ã™ã‚‹</button>
       </div>
    </div>

    <div id="infoContent"></div>
    <div class="back-btn-container" id="infoBackBtnBottom" style="display:none; margin-top:30px;">
      <button onclick="closeInfo()">ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <span class="close-modal" id="closeModalBtn">&times;</span>
      <div class="modal-tags" id="modalTags"></div>
      <div class="modal-img-wrapper"><img id="modalImg" src="" class="modal-img" /></div>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-row">
        <span class="modal-label">è²·å–ä¾¡æ ¼</span><span class="modal-price" id="modalPrice"></span>
      </div>
      <div style="text-align:right; margin-top:5px;"><span class="limit" id="modalLimit" style="font-size:14px; padding:4px 10px;"></span></div>
      
      <div id="modalCartActions" class="modal-cart-actions">
         <div class="modal-qty-group">
            <button class="modal-qty-btn" id="modalQtyMinus">-</button>
            <input class="modal-qty-input" id="modalQtyInput" value="1" readonly>
            <button class="modal-qty-btn" id="modalQtyPlus">+</button>
         </div>
         <button class="modal-add-btn" id="modalAddBtn">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      </div>

    </div>
  </div>

  <footer>
    <div class="footer-links">
      <a class="footer-link" onclick="openInfo('company')">ä¼šç¤¾æ¦‚è¦</a><span style="color:#333">|</span>
      <a class="footer-link" onclick="openInfo('privacy')">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a><span style="color:#333">|</span>
      <a class="footer-link" onclick="openInfo('terms')">åˆ©ç”¨è¦ç´„</a>
    </div>
    <div class="copyright">Â© 2026 ãƒˆãƒ¬ã‚«ãƒ•ã‚©ãƒ¼ã‚¹</div>
    <div class="footer-version">v32.0</div>
  </footer>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbw08oFxfH6FsxcJ77mgNLeticvOFaq2rknNBK3emZgwmhsM5-sB_ltBhbuKamoXHkV8/exec";
    const BANNER_IMAGES = ["./banner1.png", "./banner2.png"];
    const CACHE_DURATION = 60000; 
    // â˜…é‡è¦: ã“ã“ã«å–å¾—ã—ãŸLIFF IDã‚’å…¥ã‚Œã¦ãã ã•ã„
    const YOUR_LIFF_ID = "2009235415-7g6be2ed"; 

    let ALL_DATA = {}, CURRENT_ITEMS = [], CUR_PAGE = 1, CART = {};
    let lineUserId = ""; // LINE IDä¿æŒç”¨
    const ITEMS_per_PAGE = 60;
    const urlParams = new URLSearchParams(window.location.search);
    let currentCategory = urlParams.get('cat') || "ãƒã‚±ãƒ¢ãƒ³";
    let isMailMode = urlParams.get('mode') === 'mail';

    const el = (id) => document.getElementById(id);
    const yen = (n) => "Â¥" + Number(n).toLocaleString();

    // LIFFåˆæœŸåŒ–
    window.onload = function() {
      // æ—¢å­˜ã®åˆæœŸåŒ–
      updateModeUI();
      loadData();

      // LIFF SDKãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèª
      if(typeof liff !== 'undefined') {
        initializeLiff(YOUR_LIFF_ID);
      }
    };

    function initializeLiff(myLiffId) {
      liff
        .init({ liffId: myLiffId })
        .then(() => {
          if (liff.isLoggedIn()) {
             getProfile();
          } else {
             // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ï¼ˆå¼·åˆ¶ã™ã‚‹å ´åˆï¼‰
             // liff.login();
          }
        })
        .catch((err) => {
          console.log('LIFF Initialization failed ', err);
        });
    }

    function getProfile() {
      liff.getProfile().then(function(profile) {
        lineUserId = profile.userId;
        // æœ¬æ¥ã¯ã“ã“ã§GASã«å•ã„åˆã‚ã›ã¦ä¼šå“¡æƒ…å ±ã‚’å–å¾—ã™ã‚‹
        // ä»Šå›ã¯ãƒ¢ãƒƒã‚¯ã¨ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã®ã¿
        console.log("LINE ID: " + lineUserId);
      }).catch(function(error) {
        console.log('Error getting profile: ' + error);
      });
    }

    function updateDate(d) {
      if(!d) d = new Date();
      const min = String(d.getMinutes()).padStart(2, '0');
      el("date-display").textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${min} æ›´æ–°`;
      el("date-display").style.display = "block"; 
    }

    function updateDeadline() {
      const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const now = new Date();
      now.setDate(now.getDate() + 2); 
      const m = now.getMonth() + 1;
      const d = now.getDate();
      const w = days[now.getDay()];
      const deadlineText = `${m}æœˆ${d}æ—¥ï¼ˆ${w}ï¼‰`;
      el("mailDeadline").innerHTML = `
        ã‚µã‚¤ãƒˆã‚ˆã‚Šã”äºˆç´„ã„ãŸã ã„ãŸå ´åˆã€${deadlineText}17æ™‚ã¾ã§ã«<br class="br-sp">
        å•†å“ãŒåˆ°ç€ã™ã‚Œã°ã€ãŠç”³è¾¼æ™‚ã®é‡‘é¡ã‚’æº€é¡ã«ã¦è²·å–æŸ»å®šã„ãŸã—ã¾ã™ã€‚<br>
        ä¸Šè¨˜æ—¥æ™‚ã‚’éãã¦å•†å“ãŒåˆ°ç€ã—ãŸå ´åˆã¯ã€ç€æ‰•ã„ã§ã®ã”è¿”é€ã€<br class="br-sp">
        ã‚‚ã—ãã¯åˆ°ç€æ—¥æ™‚ç‚¹ã®ç›¸å ´ã«ã¦å†æŸ»å®šã¨ãªã‚Šã¾ã™ã€‚
      `;
    }

    function updateModeUI() {
      if(isMailMode) {
        document.body.classList.add('mail-mode');
        el("mainTitle").textContent = "éƒµé€è²·å–è¡¨";
        initSlider(); renderCartBar(); updateDeadline();
        el("showSoldOutLabel").style.display = "flex"; 
      } else {
        document.body.classList.remove('mail-mode');
        el("mainTitle").textContent = "åº—é ­è²·å–è¡¨";
        el("cartBar").classList.remove("visible");
        el("showSoldOutLabel").style.display = "flex"; 
      }
      el("date-display").style.display = "block";
    }

    // Slider
    function initSlider() {
      if(BANNER_IMAGES.length === 0) { el("bannerSlider").style.display='none'; return; }
      el("sliderWrapper").innerHTML = BANNER_IMAGES.map(s=>`<div class="slider-slide"><img src="${s}"></div>`).join("");
      el("sliderDots").innerHTML = BANNER_IMAGES.map((_,i)=>`<div class="slider-dot ${i===0?'active':''}" onclick="moveSlide(${i})"></div>`).join("");
    }
    let slideIdx = 0;
    function moveSlide(i) {
      slideIdx = i;
      el("sliderWrapper").style.transform = `translateX(-${i*100}%)`;
      document.querySelectorAll(".slider-dot").forEach((d,n)=>d.classList.toggle("active",n===i));
    }
    setInterval(() => { if(isMailMode) moveSlide((slideIdx+1)%BANNER_IMAGES.length); }, 4000);
    const wrap = el("sliderWrapper");
    let startX=0;
    wrap.addEventListener('touchstart',e=>startX=e.touches[0].clientX,{passive:true});
    wrap.addEventListener('touchend',e=>{
       let diff=startX-e.changedTouches[0].clientX;
       if(Math.abs(diff)>50) moveSlide(slideIdx+(diff>0?1:-1));
    },{passive:true});

    // Pull to Refresh (æ”¹è‰¯ç‰ˆ)
    let ptrStartY = 0;
    let isPulling = false;
    const ptrIndicator = el("ptr-indicator");

    window.addEventListener('touchstart', (e) => {
      if (document.documentElement.scrollTop === 0 && document.body.scrollTop === 0) {
        ptrStartY = e.touches[0].clientY;
        isPulling = true;
      } else {
        isPulling = false;
      }
    }, {passive: true});

    window.addEventListener('touchmove', (e) => {
      if (!isPulling) return;
      const y = e.touches[0].clientY;
      const diff = y - ptrStartY;
      if (diff > 0 && (document.documentElement.scrollTop === 0 && document.body.scrollTop === 0)) {
        if (e.cancelable) e.preventDefault(); 
        if (diff > 70) { ptrIndicator.classList.add('visible'); } else { ptrIndicator.classList.remove('visible'); }
      } else {
        isPulling = false; ptrIndicator.classList.remove('visible');
      }
    }, {passive: false});

    window.addEventListener('touchend', (e) => {
      if (!isPulling) return;
      isPulling = false;
      const y = e.changedTouches[0].clientY;
      const diff = y - ptrStartY;
      if (diff > 70 && (document.documentElement.scrollTop === 0 && document.body.scrollTop === 0)) {
         ALL_DATA = {}; sessionStorage.clear(); 
         loadData().then(() => { setTimeout(() => { ptrIndicator.classList.remove('visible'); }, 800); });
      } else {
        ptrIndicator.classList.remove('visible');
      }
    }, {passive: true});

    // Data Load
    async function loadData() {
      const sheetName = isMailMode ? "éƒµé€"+currentCategory : currentCategory;
      if(ALL_DATA[sheetName]) { render(); return; }
      const cacheKey = `cache_${sheetName}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (cached) {
        const parsed = JSON.parse(cached);
        if (Date.now() - parsed.timestamp < CACHE_DURATION) {
          ALL_DATA[sheetName] = parsed.data;
          updateDate(new Date(parsed.timestamp));
          render(); return;
        }
      }
      el("grid").innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      try {
        const fetchTime = Date.now();
        const res = await fetch(`${API}?category=${sheetName}&t=${fetchTime}`);
        const data = await res.json();
        if(data.error) throw new Error(data.error);
        ALL_DATA[sheetName] = data;
        sessionStorage.setItem(cacheKey, JSON.stringify({ timestamp: fetchTime, data: data }));
        updateDate(new Date(fetchTime)); 
        render();
      } catch(e) {
        el("grid").innerHTML = `<div style="grid-column:1/-1;color:red;text-align:center;">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
      }
    }

    el("reload").onclick = () => { ALL_DATA = {}; sessionStorage.clear(); loadData(); };

    function render() {
      const data = ALL_DATA[isMailMode ? "éƒµé€"+currentCategory : currentCategory];
      if(!data || !data.items) return;
      let items = data.items.filter(x => {
        const q = el("q").value.toLowerCase();
        return !q || (x.name+x.series).toLowerCase().includes(q);
      });
      if(!el("showSoldOut").checked) items = items.filter(x => x.remaining > 0);
      const sort = el("sort").value;
      const typePrio = {"PSA10":1,"æœªé–‹å°":2,"ç´ ä½“":3,"ã‚·ãƒ³ã‚°ãƒ«":3,"BOX":4};
      items.sort((a,b) => {
        let typeA = (a.type==="ç´ ä½“"||a.type==="ã‚·ãƒ³ã‚°ãƒ«") ? 3 : (typePrio[a.type]||99);
        let typeB = (b.type==="ç´ ä½“"||b.type==="ã‚·ãƒ³ã‚°ãƒ«") ? 3 : (typePrio[b.type]||99);
        if(typeA !== typeB) return typeA - typeB;
        return sort==="price_asc" ? a.price-b.price : b.price-a.price;
      });
      CURRENT_ITEMS = items;
      CUR_PAGE = 1;
      renderPage();
    }

    function renderPage() {
      const start = (CUR_PAGE-1)*ITEMS_per_PAGE;
      const pageItems = CURRENT_ITEMS.slice(start, start+ITEMS_per_PAGE);
      el("grid").innerHTML = pageItems.map((item, i) => {
        const idx = start + i;
        const isSold = item.remaining <= 0;
        const img = item.imageUrl ? `<img src="${item.imageUrl}" class="card-img" loading="lazy">` : `<div class="card-img no-img">No Image</div>`;
        const badge = (item.type==="ç´ ä½“"||item.type==="ã‚·ãƒ³ã‚°ãƒ«") && item.grade ? `<span class="badge-sotai">${item.grade}</span>` : "";
        const displayType = (item.type === "ç´ ä½“") ? "ã‚·ãƒ³ã‚°ãƒ«" : (item.type || "PSA10");
        let actions = "";
        let overlay = "";
        if (isSold) {
             overlay = `<div class="sold-out-overlay"><div class="sold-out-badge">è²·å–çµ‚äº†</div></div>`;
        } else if (isMailMode) {
            const key = item.id || `temp-${idx}`; 
            actions = `
              <div class="cart-actions">
                <div class="qty-group">
                  <button class="qty-btn" onclick="event.stopPropagation();chQty('${key}', -1)">-</button>
                  <input class="qty-input" id="qty-${key}" value="1" readonly onclick="event.stopPropagation()">
                  <button class="qty-btn" onclick="event.stopPropagation();chQty('${key}', 1, ${item.remaining})">+</button>
                </div>
                <button class="add-btn" onclick="event.stopPropagation();addCart('${key}', ${idx})">è¿½åŠ </button>
              </div>`;
        }
        return `
          <div class="card ${isSold?'sold-out':''}" data-index="${idx}">
            ${overlay}
            <div style="${isSold?'opacity:0.6':''}">
              ${img}
              <div class="card-tags">${badge}</div>
              <div class="card-body">
                <div class="card-header-row">
                  <span class="type-label">${displayType}</span>
                  <span class="limit-badge">æ®‹:${item.remaining}</span>
                </div>
                <div class="card-title">${item.name}</div>
                <div class="card-footer">
                  <div class="price-row">
                    <span class="price-label">è²·å–ä¾¡æ ¼</span>
                    <span class="price-value">${yen(item.price)}</span>
                  </div>
                  ${actions}
                </div>
              </div>
            </div>
          </div>`;
      }).join("");
      el("paginationCtrl").style.display = CURRENT_ITEMS.length > ITEMS_per_PAGE ? "flex" : "none";
      el("pageInfo").innerText = `${CUR_PAGE} / ${Math.ceil(CURRENT_ITEMS.length/ITEMS_per_PAGE)}`;
    }

    function chQty(key, d, max) {
      const inp = el(`qty-${key}`);
      let v = parseInt(inp.value) + d;
      if(v<1) v=1; if(max && v>max) v=max;
      inp.value = v;
    }

    function addCart(key, idx) {
      const item = CURRENT_ITEMS[idx];
      const qty = parseInt(el(`qty-${key}`).value);
      _addToCartLogic(item, qty);
    }
    
    function _addToCartLogic(item, qty) {
      const key = item.id || item.name;
      if(!CART[key]) CART[key] = { item: item, qty: 0 };
      if(CART[key].qty + qty > item.remaining) { alert("è²·å–å¯èƒ½æšæ•°ã‚’è¶…ãˆã¦ãŠã‚Šã¾ã™"); return; }
      CART[key].qty += qty;
      renderCartBar();
      if(el("modal").classList.contains("active")) {
          const btn = el("modalAddBtn");
          btn.textContent = "è¿½åŠ ã—ã¾ã—ãŸ";
          setTimeout(() => btn.textContent = "ã‚«ãƒ¼ãƒˆã«è¿½åŠ ", 1000);
      }
    }

    function renderCartBar() {
      const keys = Object.keys(CART);
      if(keys.length===0) { 
        el("cartBar").classList.remove("visible"); 
        el("headerCartCount").style.display='none';
        return; 
      }
      let count=0, total=0;
      keys.forEach(k => {
        count += CART[k].qty;
        total += CART[k].item.price * CART[k].qty;
      });
      el("cartTotalPrice").innerText = yen(total);
      el("cartTotalCount").innerText = `(${count}ç‚¹)`;
      el("cartBar").classList.add("visible");
      el("headerCartCount").innerText = count;
      el("headerCartCount").style.display = 'flex';
    }

    function openCart() {
      el("mainView").style.display = "none";
      el("cartBar").classList.remove("visible");
      el("cartView").style.display = "block";
      window.scrollTo(0,0);
      const list = el("cartItemsList");
      const keys = Object.keys(CART);
      if(keys.length===0) {
        list.innerHTML = "<p style='text-align:center;color:#aaa'>ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>";
        el("cartViewTotal").innerText = "Â¥0";
        return;
      }
      let total = 0;
      list.innerHTML = keys.map(k => {
        const c = CART[k];
        total += c.item.price * c.qty;
        const img = c.item.imageUrl ? `<img src="${c.item.imageUrl}" class="cart-item-img">` : `<div class="cart-item-img"></div>`;
        return `
          <div class="cart-item">
            ${img}
            <div class="cart-item-info">
              <div class="cart-item-title">${c.item.name}</div>
              <div class="cart-item-meta">ã€${c.item.type}ã€‘ å˜ä¾¡:${yen(c.item.price)}</div>
              <div class="cart-item-price">å°è¨ˆ: ${yen(c.item.price * c.qty)}</div>
              <div class="cart-item-actions">
                <div class="qty-group">
                  <button class="qty-btn" onclick="updateCart('${k}', -1)">-</button>
                  <input class="qty-input" value="${c.qty}" readonly>
                  <button class="qty-btn" onclick="updateCart('${k}', 1, ${c.item.remaining})">+</button>
                </div>
                <button class="delete-btn" onclick="removeCart('${k}')">å‰Šé™¤</button>
              </div>
            </div>
          </div>`;
      }).join("");
      el("cartViewTotal").innerText = yen(total);
    }

    function updateCart(key, d, max) {
      CART[key].qty += d;
      if(CART[key].qty < 1) CART[key].qty = 1;
      if(max && CART[key].qty > max) { CART[key].qty = max; alert("è²·å–å¯èƒ½æšæ•°ã‚’è¶…ãˆã¦ãŠã‚Šã¾ã™"); }
      openCart(); renderCartBar();
    }
    function removeCart(key) { delete CART[key]; openCart(); renderCartBar(); }
    function closeCart() { el("cartView").style.display = "none"; el("mainView").style.display = "block"; renderCartBar(); }

    const drawer = el("drawerMenu"); const overlay = el("drawerOverlay");
    function toggleDrawer() { drawer.classList.toggle("open"); overlay.classList.toggle("open"); }
    el("hamburgerBtn").onclick = toggleDrawer; overlay.onclick = toggleDrawer;

    el("menuStore").onclick = () => { isMailMode=false; switchMode(); toggleDrawer(); closeInfo(); };
    el("menuMail").onclick = () => { isMailMode=true; switchMode(); toggleDrawer(); closeInfo(); };

    function switchMode() {
      const url = new URL(location);
      url.searchParams.set("cat", currentCategory);
      if(isMailMode) url.searchParams.set("mode","mail"); else url.searchParams.delete("mode");
      history.pushState({},"",url);
      closeCart();
      updateModeUI(); loadData();
    }

    document.querySelectorAll(".nav-item").forEach(t => {
      t.onclick = (e) => {
        document.querySelectorAll(".nav-item").forEach(x=>x.classList.remove("active"));
        e.target.classList.add("active");
        currentCategory = e.target.dataset.cat;
        switchMode();
      };
    });

    el("sort").onchange = render; el("showSoldOut").onchange = render;
    el("q").oninput = () => setTimeout(render, 300);
    el("reload").onclick = () => { ALL_DATA={}; loadData(); };
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰
    el("prevBtn").onclick = () => { CUR_PAGE--; renderPage(); };
    el("nextBtn").onclick = () => { CUR_PAGE++; renderPage(); };

    // æƒ…å ±ç”»é¢ãƒ‡ãƒ¼ã‚¿
    const contentData = {
      privacy: `<p>ï¼ˆçœç•¥ï¼šv27.0ã¨åŒã˜ï¼‰</p>`, // â˜…é•·ããªã‚‹ã®ã§çœç•¥ã€å®Ÿéš›ã¯v27.0ã®ä¸­èº«ã‚’å…¥ã‚Œã¦ãã ã•ã„
      terms: `<p>ï¼ˆçœç•¥ï¼šv27.0ã¨åŒã˜ï¼‰</p>`,   // â˜…é•·ããªã‚‹ã®ã§çœç•¥
      company: `...ï¼ˆv29.0ã¨åŒã˜ï¼‰...`,
      flow: `...ï¼ˆv29.0ã¨åŒã˜ï¼‰...`,
      rules: `<p>ï¼ˆæº–å‚™ä¸­ï¼‰</p>`
    };
    
    // â˜…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ã‚­ã‚¹ãƒˆé‡ãŒå¤šã„ã®ã§çœç•¥ã—ã¦ã„ã¾ã™ãŒã€v29.0ã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰
    // å®Ÿéš›ã®å®Ÿè£…æ™‚ã¯ã“ã“ã«å…¨æ–‡ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚

    function openInfo(t) {
      el("mainView").style.display="none"; el("cartView").style.display="none"; el("infoView").style.display="block";
      
      // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´ & æ—¥æ™‚éè¡¨ç¤º
      let title = "æƒ…å ±";
      if(t === 'member') title = "ä¼šå“¡è¨¼ãƒ»ç™»éŒ²";
      else if(t === 'company') title = "ä¼šç¤¾æ¦‚è¦";
      else if(t === 'privacy') title = "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼";
      else if(t === 'terms') title = "åˆ©ç”¨è¦ç´„";
      else if(t === 'flow') title = "è²·å–ã®æµã‚Œ";
      else if(t === 'rules') title = "è²·å–åŸºæº–";
      
      el("mainTitle").textContent = title;
      el("date-display").style.display = "none"; 
      
      // ä¼šå“¡ç”»é¢ã¨é€šå¸¸æƒ…å ±ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆ
      if(t === 'member') {
        el("memberSection").style.display = "block";
        el("infoContent").innerHTML = ""; // ç©ºã«ã™ã‚‹
        
        // ä»®ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼šã¨ã‚Šã‚ãˆãšæœªç™»éŒ²çŠ¶æ…‹ã‚’è¡¨ç¤º
        // å®Ÿè£…æ™‚ã¯LINE IDã§GASã«å•ã„åˆã‚ã›ã¦åˆ†å²
        el("memberRegView").style.display = "block"; 
        el("memberCardView").style.display = "none";
        
        // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ
        // JsBarcode("#barcode", "123456789", {format: "CODE128", displayValue: true});
        
      } else {
        el("memberSection").style.display = "none";
        el("infoContent").innerHTML = contentData[t] || "æº–å‚™ä¸­";
      }
      
      const showBack = (t === 'flow' || t === 'rules') ? 'block' : 'none';
      el('infoBackBtnTop').style.display = showBack;
      el('infoBackBtnBottom').style.display = showBack;

      if(drawer.classList.contains("open")) toggleDrawer();
      window.scrollTo(0,0);
    }
    
    function showMemberEdit() {
      el("memberCardView").style.display = "none";
      el("memberRegView").style.display = "block";
    }
    
    function submitMember() {
      alert("ç™»éŒ²å‡¦ç†ï¼ˆä»®ï¼‰");
      // ã“ã“ã§GASã«é€ä¿¡ã™ã‚‹å‡¦ç†ã‚’æ›¸ã
      el("memberRegView").style.display = "none";
      el("memberCardView").style.display = "block";
      JsBarcode("#barcode", "MEM-00001", {format: "CODE128", displayValue: true});
      el("memNo").innerText = "MEM-00001";
      el("memName").innerText = el("regName").value || "åç„¡ã—";
    }
    
    function closeInfo() {
      el("infoView").style.display="none"; el("mainView").style.display="block"; 
      switchMode(); // ã‚¿ã‚¤ãƒˆãƒ«ç­‰ã‚’å…ƒã«æˆ»ã™
      window.scrollTo(0,0);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    const modal = el("modal");
    const closeModalBtn = el("closeModalBtn");
    let currentModalItem = null;
    el("modalQtyMinus").onclick = () => { let v = parseInt(el("modalQtyInput").value); if(v > 1) el("modalQtyInput").value = v - 1; };
    el("modalQtyPlus").onclick = () => { let v = parseInt(el("modalQtyInput").value); if(currentModalItem && v < currentModalItem.remaining) el("modalQtyInput").value = v + 1; };
    el("modalAddBtn").onclick = () => { if(currentModalItem) { const qty = parseInt(el("modalQtyInput").value); _addToCartLogic(currentModalItem, qty); } };

    el("grid").addEventListener("click", (e) => {
      if(e.target.closest(".cart-actions")) return;
      const card = e.target.closest(".card");
      if (card) {
        const item = CURRENT_ITEMS[card.dataset.index];
        if (item) openModal(item);
      }
    });
    
    function openModal(item) {
      currentModalItem = item;
      el("modalImg").style.display = item.imageUrl ? "inline-block" : "none";
      if(item.imageUrl) el("modalImg").src = item.imageUrl;
      el("modalTitle").textContent = item.name;
      el("modalPrice").textContent = yen(item.price);
      el("modalLimit").textContent = "æ®‹ã‚Š: " + item.remaining;
      const displayType = (item.type === "ç´ ä½“") ? "ã‚·ãƒ³ã‚°ãƒ«" : (item.type || "PSA10");
      el("modalTags").innerHTML = `<span class="type-label">${displayType}</span>`;
      
      if(isMailMode && item.remaining > 0) {
        el("modalCartActions").style.display = "flex";
        el("modalQtyInput").value = 1;
      } else {
        el("modalCartActions").style.display = "none";
      }
      modal.classList.add("active");
    }
    closeModalBtn.onclick = () => modal.classList.remove("active");
    modal.onclick = (e) => { if(e.target === modal) modal.classList.remove("active"); };

    // åˆæœŸåŒ–
    updateModeUI(); loadData();
  </script>
</body>
</html>
